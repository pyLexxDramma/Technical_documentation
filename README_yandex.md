# Yandex Bot

## 1. Назначение модуля

Модуль **Yandex Bot** предназначен для **автоматизации обработки отзывов** на платформе Яндекс.Справочник. Он включает
функциональность для получения комментариев, их обработки с использованием OpenAI API, отправки ответов и ведения логов.
Модуль также поддерживает интеграцию с вебсокетами для передачи уведомлений.

## 2. Основные компоненты и функции

### 2.1. Работа с отзывами

* **`poll_comments()`**
    * **Описание:** Периодически проверяет наличие новых комментариев на платформе Яндекс.Справочник и передает их на
      обработку.

* **`process_comment(comment, post, csrf_token, username)`**
    * **Описание:** Обрабатывает отдельный комментарий, включая проверку баланса, определение необходимости ответа и
      отправку ответа.
    * **Параметры:**
        * `comment` Данные комментария.
        * `post` Связанные данные поста.
        * `csrf_token` CSRF-токен для аутентификации.
        * `username` Имя пользователя.

* **
  `log_combined(comment_id: str, comment_text: str, reply_text: str, username: str, tonality_rating: str = None, post_id: str = None, comment_created_date: datetime = None)`
  **
    * **Описание:** Регистрирует комментарий и ответ в журнале и базе данных.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.
        * `comment_text` Текст комментария.
        * `reply_text` Текст ответа.
        * `username` Имя пользователя.
        * `tonality_rating` Рейтинг тональности (опционально).
        * `post_id` Идентификатор поста (опционально).
        * `comment_created_date` Дата создания комментария (опционально).

### 2.2. Управление базами данных

* **`get_db_connection()`**
    * **Описание:** Устанавливает соединение с базой данных MySQL.

* **
  `add_to_pending(comment_id, post_id, csrf_token, bsn_csrf, post_text, user_id, comment_text, bot_response, response_key, username, created_at=None)`
  **
    * **Описание:** Добавляет комментарий в очередь на модерацию.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.
        * `post_id` Идентификатор поста.
        * `csrf_token` CSRF-токен.
        * `bsn_csrf` BSN CSRF-токен.
        * `post_text` Текст поста.
        * `user_id` Идентификатор пользователя.
        * `comment_text` Текст комментария.
        * `bot_response` Ответ бота.
        * `response_key` Ключ ответа.
        * `username` Имя пользователя.
        * `created_at` Время добавления (опционально).

* **`remove_from_pending(comment_id)`**
    * **Описание:** Удаляет комментарий из очереди модерации.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.

* **`is_pending(comment_id)`**
    * **Описание:** Проверяет, находится ли комментарий в очереди модерации.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.

* **`is_responded(comment_id)`**
    * **Описание:** Проверяет, был ли уже дан ответ на комментарий.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.

* **`is_comment_processed(comment_id, processed_comments)`**
    * **Описание:** Комплексная проверка статуса обработки комментария.
    * **Параметры:**
        * `comment_id` Идентификатор комментария.
        * `processed_comments` Список уже обработанных комментариев.

### 2.3. Интеграция с OpenAI

* **`generate_history_key(user_id, post_id)`**
    * **Описание:** Генерирует уникальный ключ истории диалога.
    * **Параметры:**
        * `user_id` Идентификатор пользователя.
        * `post_id` Идентификатор поста.

* **`get_chatgpt_answer(user_text, user_id, post_id, post_text=None)`**
    * **Описание:** Получает ответ от OpenAI API на основе введенного текста.
    * **Параметры:**
        * `user_text` Текст пользователя.
        * `user_id` Идентификатор пользователя.
        * `post_id` Идентификатор поста.
        * `post_text` Текст поста (опционально).

* **`get_tonality_rating(text: str) -> int`**
    * **Описание:** Оценивает тональность текста с использованием OpenAI API.
    * **Параметры:**
        * `text` Текст для оценки.

### 2.4. Вебсокеты и уведомления

* **`send_to_websocket(message)`**
    * **Описание:** Отправляет уведомление через вебсокет-сервер.
    * **Параметры:**
        * `message` Сообщение для отправки.

### 2.5. Авторизация и управление сессиями

* **`renew_token(expired_token)`**
    * **Описание:** Обновляет токен сеанса для аутентификации.
    * **Параметры:**
        * `expired_token` Устаревший токен.

* **`check_auth()`**
    * **Описание:** Проверяет действительность токенов сеанса и обновляет их при необходимости.

### 2.6. Прочие функции

* **`run_bot()`**
    * **Описание:** Основной метод запуска бота, инициализирует журналы и запускает цикл опроса комментариев.

## 3. Окружение, необходимое для работы

### Зависимости Python

* **Python:** >= 3.8
* **aiohttp**: Библиотека для асинхронных HTTP-запросов.
* **requests:** Библиотека для синхронных HTTP-запросов.
* **dotenv:** Загрузка переменных окружения из *.env* файлов.
* **logging**: Стандартная библиотека для ведения журналов.

### Переменные окружения

Переменные окружения загружаются из файла *.env* и включают:

* `YANDEX_API_TOKEN` Токен API для Яндекс.Справочника.
* `OPENAI_API_KEY` Ключ API для OpenAI.
* `YANDEX_COMMENTS_URL` URL для получения комментариев Яндекс.Справочника.
* `WEBSOCKET_URL` URL для вебсокет-сервера.
* `DB_URL` URL для подключения к базе данных MySQL.
* `LOG_FILE` Имя файла для логов.

## 4. Связи между модулями и дополнительными модулями

| Компонент          | Входящие связи                    | Исходящие связи                 |
|:-------------------|:----------------------------------|:--------------------------------|
| Yandex Bot Main    | Все модули                        | Пользователи (через Yandex API) |
| Review Processor   | Yandex Bot Main, OpenAI API       | Yandex API, OpenAI API          |
| Database Module    | Yandex Bot Main, Review Processor | MySQL Database                  |
| Logging Module     | Yandex Bot Main, Review Processor | Лог-файлы                       |
| OpenAI Integration | Review Processor                  | OpenAI API                      |
| WebSocket Module   | Review Processor                  | Внешний сервис через вебсокеты  |
| Utils              | Review Processor                  | Различные внутренние компоненты |
| AsyncFileHandler   | Review Processor                  | Файлы логов и данных            |

---

**Заключение:**
**Yandex Bot** представляет собой **комплексное решение** для автоматизации обработки отзывов на Яндекс.Справочнике. Он
интегрируется с OpenAI API, поддерживает асинхронную обработку, управление базой данных и уведомления через вебсокеты.