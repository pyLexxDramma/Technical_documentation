## Модули и Компоненты

### 1. Главный модуль `main.py`

* **Назначение:** Является точкой входа в приложение и управляет всеми основными процессами.
* **Детали:** Организует взаимодействие между различными компонентами приложения, такими как обработка сообщений, работа
  с базой данных и логирование.
* **Функция:**
  `if __name__ == "__main__":`
* **Описание:** Запускает основное приложение Flask и организует его работу на указанном порту.

### 2. Модуль обработки сообщений `vk_callback2`

* **Назначение:** Обрабатывает входящие сообщения от пользователей и формирует соответствующие реакции.
* **Функция (маршрут):**
  `@app.route("/ego18/vk-callback2", methods=["POST"])`
* **Описание:** Обрабатывает события от VK Callback API, такие как новые комментарии и посты.

### 3. Модуль взаимодействия с базой данных `database.py`

* **Назначение:** Предоставляет методы для работы с базой данных MySQL.
* **Функции:**
    * `def get_db_connection():`
        * **Описание:** Создает подключение к базе данных.
    * `def check_balance() -> float:`
        * **Описание:** Проверяет текущий баланс в базе данных.
    * `def decrement_balance(amount: float = 5.0):`
        * **Описание:** Снижает баланс на указанное значение.
    * `def record_message_to_db(...):`
        * **Описание:** Записывает сообщения в базу данных.

### 4. Модуль логирования `logging.py`

* **Назначение:** Настраивает и управляет журналом событий приложения.
* **Функция:**
  `def setup_logger(name, log_file):`
* **Описание**: Настраивает логирование с использованием стандартного модуля Python logging.

### 5. Модуль интеграции с OpenAI `openai_api.py`

* **Назначение:** Интегрируется с API OpenAI для генерации ответов на сообщения пользователей.
* **Функция:**
    * `def get_chatgpt_answer(...)`
        * **Описание:** Отправляет запросы к OpenAI и обрабатывает полученные ответы.

### 6. Модуль вебсокетов `websocket.py`

* **Назначение:** Обеспечивает связь с внешним сервисом через вебсокеты.
* **Функция:**
    * `async def sendWebSocket(id_lastResponses)`
        * **Описание:** Отправляет уведомления через вебсокеты.

### 7. Вспомогательные утилиты `utils.py`

* **Назначение:** Включает вспомогательные функции для общего использования.
* **Функции:**
    * `def load_system_prompts_vk() -> tuple:`
        * **Описание:** Загружает системные подсказки для OpenAI.
    * `def extract_deadline(post_text: str) -> Optional[datetime]:`
        * **Описание:** Извлекает сроки из текста сообщений.

### 8. Модуль асинхронной записи в файлы `AsyncFileHandler`

* **Назначение:** Обеспечивает асинхронную запись данных в файлы.
* **Класс:**
    * `class AsyncFileHandler:`
        * **Описание:** Класс для асинхронной записи данных в файлы с поддержкой очередей.

---

## 2. Окружение, необходимое для работы

Для функционирования данного модуля необходимы следующие зависимости и окружение:

### Зависимости Python

* **Python:** >= 3.8
* **Flask:** Фреймворк для веб-разработки.
* **requests:** Библиотека для HTTP-запросов.
* **mysql-connector-python:** Драйвер для работы с MySQL.
* **websockets:** Библиотека для работы с вебсокетами.
* **dotenv:** Загрузка переменных окружения из *.env* файлов.
* **logging:** Стандартная библиотека для ведения журналов.

### Необходимые сервисы

* **VK API:** Сервис для взаимодействия с социальной сетью ВКонтакте.
* **MySQL Server:** База данных для хранения данных приложения.

### Требуемые права доступа и разрешения

* **Права на запись:** К каталогам для хранения логов и временных файлов.
* **Права на выполнение:** Для запуска скриптов и служб.

## 3. Связи между модулями и дополнительными модулями

| Компонент          | Входящие связи            | Исходящие связи                 |
|:-------------------|:--------------------------|:--------------------------------|
| Main App           | Все модули                | Пользователи (через VK API)     |
| Handle Messages    | Main App, OpenAI API      | VK API                          |
| Database Module    | Main App, Handle Messages | MySQL Database                  |
| Logging Module     | Main App, Handle Messages | Log Files                       |
| OpenAI Integration | Handle Messages           | OpenAI API                      |
| WebSocket Module   | Handle Messages           | Внешний сервис через вебсокеты  |
| Utils              | Handle Messages           | Различные внутренние компоненты |
| AsyncFileHandler   | Handle Messages           | Файлы логов и данных            |

**Заключение:**
Данный модуль представляет собой комплексный VK-бот, интегрированный с OpenAI и поддерживающий асинхронную обработку
сообщений и взаимодействие с внешней средой через вебсокеты.