## Модули и Компоненты

### 1. Главный модуль `main.py`

* **Назначение:** Является точкой входа в приложение и управляет всеми основными процессами.
* **Детали:** Организует взаимодействие между различными компонентами приложения, такими как обработка комментариев,
  работа с базой данных и логирование.
* **Функция:**
    * `run_bot():`
        * **Описание:** Запускает основной процесс бота, инициализирует необходимые файлы и проверяет доступность API
          перед началом опроса комментариев.

### 2. Модуль обработки комментариев `poll_comments`

* **Назначение:** Периодически проверяет наличие новых комментариев и обрабатывает их.
* **Функция:**
    * `poll_comments():`
        * **Описание:** Циклически проверяет новые комментарии, обрабатывает их и взаимодействует с API 2GIS.

### 3. Модуль взаимодействия с базой данных `database.py`

* **Назначение:** Предоставляет методы для работы с базой данных MySQL.
* **Функции:**
    * `def get_db_connection():`
        * **Описание:** Создает подключение к базе данных.
    * `def check_balance() -> float:`
        * **Описание:** Проверяет текущий баланс в базе данных.
    * `def decrement_balance(amount: float = 5.0):`
        * **Описание:** Снижает баланс на указанное значение.
    * `def log_combined(...):`
        * **Описание:** Записывает комментарии в базу данных и лог-файл.

### 4. Модуль логирования `logging.py`

* **Назначение:** Настраивает и управляет журналом событий приложения.
* **Функция:**
    * `def setup_logger(name, log_file):`
        * **Описание:** Настраивает логирование с использованием стандартного модуля Python logging.

### 5. Модуль интеграции с OpenAI `openai_api.py`

* **Назначение:** Интегрируется с API OpenAI для генерации ответов на комментарии.
* **Функция:**
    * `def get_chatgpt_answer(...)`
        * **Описание:** Отправляет запросы к OpenAI и обрабатывает полученные ответы.

### 6. Модуль вебсокетов `websocket.py`

* **Назначение:** Обеспечивает связь с внешним сервисом через вебсокеты.
* **Функция:**
    * `def send_to_websocket(message):`
        * **Описание:** Отправляет уведомления через вебсокеты.

### 7. Вспомогательные утилиты `utils.py`

* **Назначение:** Включает вспомогательные функции для общего использования.
* **Функции:**
    * `def load_system_prompt() -> str:`
        * **Описание:** Загружает системный промпт для OpenAI.
    * `def generate_history_key(user_id, post_id):`
        * **Описание:** Генерирует ключ истории диалога.

### 8. Модуль асинхронной записи в файлы `AsyncFileHandler`

* **Назначение:** Обеспечивает асинхронную запись данных в файлы.
* **Класс:**
    * `class AsyncFileHandler:`
        * **Описание:** Класс для асинхронной записи данных в файлы с поддержкой очередей.

## 2. Окружение, необходимое для работы

Для функционирования данного модуля необходимы следующие зависимости и окружение:

### Зависимости Python

* **Python:** >= 3.8
* **httpx:** Библиотека для асинхронных HTTP-запросов.
* **requests:** Библиотека для HTTP-запросов.
* **flask:** Фреймворк для веб-разработки.
* **mysql-connector-python:** Драйвер для работы с MySQL.
* **websockets:** Библиотека для работы с вебсокетами.
* **dotenv:** Загрузка переменных окружения из *.env* файлов.
* **logging:** Стандартная библиотека для ведения журналов.

### Необходимые сервисы

* **2GIS API:** Сервис для взаимодействия с платформой 2GIS.
* **MySQL Server:** База данных для хранения данных приложения.

### Требуемые права доступа и разрешения

* **Права на запись:** К каталогам для хранения логов и временных файлов.
* **Права на выполнение:** Для запуска скриптов и служб.

---

## 3. Связи между модулями и дополнительными модулями

| Компонент          | Входящие связи          | Исходящие связи                 |
|:-------------------|:------------------------|:--------------------------------|
| Main App           | Все модули              | Пользователи (через 2GIS API)   |
| Poll Comments      | Main App, OpenAI API    | 2GIS API                        |
| Database Module    | Main App, Poll Comments | MySQL Database                  |
| Logging Module     | Main App, Poll Comments | Log Files                       |
| OpenAI Integration | Poll Comments           | OpenAI API                      |
| WebSocket Module   | Poll Comments           | Внешний сервис через вебсокеты  |
| Utils              | Poll Comments           | Различные внутренние компоненты |
| AsyncFileHandler   | Poll Comments           | Файлы логов и данных            |

**Заключение:**
Данный модуль представляет собой комплексный бот для платформы 2GIS, интегрированный с OpenAI и поддерживающий
асинхронную обработку комментариев и взаимодействие с внешней средой через вебсокеты.