# Proxy Manager

## 1. Назначение модуля

Модуль **Proxy Manager** предназначен для **управления прокси-сервером** и обработки запросов к различным API с
использованием прокси. Он обеспечивает **надежное подключение** и **автоматический переход** на следующий прокси в
случае сбоя текущего.

## 2. Основные компоненты и функции

### 2.1. Управление прокси

* **`set_next_proxy(from_bot)`**
    * **Описание:** Переключает использование прокси на следующий в списке.
    * **Параметры:**
        * `from_bot` Строка, указывающая источник переключения прокси.

* **`sync_api_request_with_retry(url, headers, payload, from_bot, comment_text="", max_retries=3)`**
    * **Описание:** Выполняет синхронный запрос к указанному URL с возможностью повторных попыток и использованием
      прокси.
    * **Параметры:**
        * `url`: Адрес для отправки запроса.
        * `headers`: Заголовки запроса.
        * `payload`: Данные для отправки.
        * `from_bot`: Источник запроса.
        * `comment_text`: Дополнительный комментарий для логирования (по умолчанию: "").
        * `max_retries`: Максимальное количество попыток (по умолчанию: 3).

* **`api_request_with_retry_tgbot(url, payload, for_error, comment_text="", max_retries=3)`**
    * **Описание:** Выполняет асинхронный запрос к указанному URL с возможностью повторных попыток и использованием
      прокси.
    * **Параметры:**
        * `url`: Адрес для отправки запроса.
        * `payload`: Данные для отправки.
        * `for_error` Значение, которое возвращается в случае ошибки.
        * `comment_text`: Дополнительный комментарий для логирования (по умолчанию: "").
        * `max_retries`: Максимальное количество попыток (по умолчанию: 3).

* **`_send_openai_request(prompt: str, image_url: str = None) -> str`**
    * **Описание:** Отправляет запрос к OpenAI API с использованием текущих настроек прокси.
    * **Параметры:**
        * `prompt`: Текст запроса.
        * `image_url`: URL изображения (опционально).

* **`set_zero_proxy(from_bot)`**
    * **Описание:** Устанавливает первый прокси в качестве активного.
    * **Параметры:**
        * `from_bot` Источник сброса прокси.

## 3. Окружение, необходимое для работы

### Зависимости Python

* **Python:** >= 3.8
* **aiohttp:** Библиотека для асинхронных HTTP-запросов.
* **requests:** Библиотека для синхронных HTTP-запросов.
* **dotenv:** Загрузка переменных окружения из *.env* файлов.
* **logging:** Стандартная библиотека для ведения журналов.

### Переменные окружения

Переменные окружения загружаются из файла `.env` и включают:

* `PROXY`: Список прокси-серверов.
* `OPENAI_API_KEY`: Ключ API для OpenAI.
* `OPENAI_API_URL`: URL для OpenAI API.
* `WORK_PROXY_NUMBER`: Текущий индекс используемого прокси.
* `CURRENT_PROXY`: Текущий активный прокси.

## 4. Связи между модулями и дополнительными модулями

| Компонент          | Входящие связи | Исходящие связи |
|:-------------------|:---------------|:----------------|
| Proxy Manager      | Все модули     | OpenAI API      |
| OpenAI Integration | Proxy Manager  | OpenAI API      |
| Logging Module     | Proxy Manager  | Лог-файлы       |

---

**Заключение:**
Модуль **Proxy Manager** является **ключевым компонентом** системы, обеспечивающим надежную передачу запросов через
прокси-серверы. Он интегрируется с OpenAI API и поддерживает ведение журнала событий для отслеживания активности и
ошибок.