# WebSocket Server

## 1. Назначение модуля

Модуль **WebSocket Server** предназначен для реализации **сервера WebSocket** с поддержкой **heartbeat** и *
*переподключения**. Он обеспечивает **надежный обмен сообщениями** между клиентами и сервером, а также **мониторинг
состояния подключений**. Сервер поддерживает интеграцию с базой данных MySQL и систему метрик для мониторинга
производительности.

## 2. Основные компоненты и функции

### 2.1. Управление WebSocket соединениями

* **class WebSocketClient**
  ```python
  @dataclass
  class WebSocketClient:
  ```
    * **Описание:** Хранит информацию о каждом подключенном клиенте WebSocket.

* **class WebSocketManager**
  ```python
  class WebSocketManager:
  ```
    * **Методы:**
        * `add_client` добавляет нового клиента в менеджер.
        * `remove_client` удаляет клиента из менеджера.
        * `update_heartbeat` обновляет время последнего heartbeat.
        * `get_alive_clients` возвращает активных клиентов.
        * `send_to_all` отправляет сообщение всем активным клиентам.
        * `start_heartbeat` запускает цикл heartbeat для поддержания соединений.

### 2.2. Система метрик

* **class Metrics**
  ```python
  class Metrics:
  ```
    * **Методы:**
        * `increment` увеличивает значение метрики.
        * `set` устанавливает значение метрики.
        * `get_stats` возвращает текущую статистику.

### 2.3. Обработка сообщений

* **echo(websocket)**
  ```python
  async def echo(websocket)
  ```
    * **Описание:** Основная функция обработки входящих сообщений от клиентов. Она поддерживает команды типа `SR` `CL`
      `HEARTBEAT`  `APPROVED`

* **fetch_post_text(response_data)**
  ```python
  async def fetch_post_text(response_data)
  ```
    * **Описание:** Дополнительно получает текст поста для платформ VK и Telegram.

* **process_pending_response(response_id)**
  ```python
  async def process_pending_response(response_id)
  ```
    * **Описание:** Обрабатывает ожидающие ответы, извлекает данные из базы данных и рендерит HTML-шаблоны.

### 2.4. Управление серверами

* **serve()**
  ```python
  async def serve()
  ```
    * **Описание:** Запускает WebSocket сервер с поддержкой SSL (при наличии сертификатов) и запускает фоновый процесс
      heartbeat.

## 3. Окружение, необходимое для работы

### Зависимости Python

* **Python:** >= 3.8
* **websockets**: Реализация протокола WebSocket.
* **Flask:** Микрофреймворк для веб-приложений.
* **MySQLdb:** Интерфейс для работы с MySQL.
* **asyncio:** Библиотека для асинхронного программирования.
* **logging:** Стандартная библиотека для ведения журналов.

### Переменные окружения

Переменные окружения загружаются из файла *.env* и включают:

* `MYSQL_HOST`, `MYSQL_USER`, `MYSQL_PASSWORD`, `MYSQL_DB`: Параметры подключения к базе данных.
* `WEBSOCKET_PORT`: Порт для WebSocket сервера.
* `SSL_CERT_FILE`, `SSL_KEY_FILE`: Пути к сертификатам SSL (опционально).

## 4. Связи между модулями и дополнительными модулями

| Компонент        | Входящие связи   | Исходящие связи          |
|:-----------------|:-----------------|:-------------------------|
| WebSocket Server | Все модули       | Клиенты WebSocket, MySQL |
| MySQL            | WebSocket Server | База данных              |

---

**Заключение:**
Модуль **WebSocket Server** представляет собой **комплексное решение** для надежного обмена сообщениями с клиентами
через протокол WebSocket. Он поддерживает **мониторинг состояний подключений**, интеграцию с базой данных и систему
метрик для мониторинга производительности.