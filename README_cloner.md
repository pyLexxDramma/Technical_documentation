## Модули и Компоненты

### 1. Модуль настройки логирования `setup_logging`

* **Назначение:** Настраивает журналирование (логирование) событий приложения.
* **Детали:** Создает файл журнала с ротацией: до 5 резервных копий, каждая размером до 10 МБ.
* **Функция:**
  `def setup_logging():`
  **Описание:** Настройка журнализации событий в приложении.
  Используется стандартный модуль Python 'logging' с обработчиком вращения файлов.

### 2. Модуль инициализации клиентского соединения `ensure_dirs`

* **Назначение:** Создает необходимые директории для хранения клонов приложений.
* **Функция:**
  `def ensure_dirs():`
  **Описание:** Обеспечивает существование необходимой структуры каталогов для дальнейшего развертывания клонов. Если
  основной каталог не существует, создает его.

### 3. Генерация текста окружения `get_env_text`

* **Назначение:** Генерирует текст файла *.env*, содержащий конфигурационные переменные среды.
* **Функция:**
  `def get_env_text(token, port, ..., session_id2):`
  **Описание:** Формирует строку конфигурации, содержащую все требуемые переменные окружения для нового клона
  приложения.

### 4. Поиск свободного вебсокет-порта `find_free_websocket_port`

* **Назначение:** Ищет свободный порт для вебсокета среди заданного диапазона портов.
* **Функция:**
  `def find_free_websocket_port():`
  **Описание:** Перебирает порты в указанном диапазоне и проверяет доступность путем попытки привязки сокета к каждому
  порту.

### 5. Создание клона `create_clone`

* **Назначение:** Осуществляет создание нового клона приложения с заданными параметрами.
* **Функция:**
  `def create_clone(token, port, ..., session_id2):`
  **Описание:** Полностью настраивает новый клон приложения, включая создание баз данных MySQL, копирование необходимых
  файлов, обновление маршрутов Nginx и запуск соответствующих процессов.

### 6. Управление компонентами клона

#### 6.1. Запуск компонента `start_component`

* **Назначение:** Запускает указанный компонент (например, бот, биллинговую систему) для конкретного клона.
* **Функция:**
  `def start_component(clone_name, component):`
  **Описание:** Осуществляет запуск процесса соответствующего компонента для указанного клона, записывая статус запуска
  в базу данных.

#### 6.2. Остановка компонента `stop_component`

* **Назначение:** Останавливает указанный компонент для конкретного клона.
* **Функция:**
  `def stop_component(clone_name, component):`
  **Описание:** Останавливает процесс соответствующего компонента, обновляя статус в базе данных.

#### 6.3. Чистка состояния ботов `cleanup_bot_states`

* **Назначение:** Очищает состояние запущенных компонентов всех клонов, останавливая активные процессы и сбрасывая
  статусы.
* **Функция:**
  `def cleanup_bot_states():`
  **Описание:** Убедившись, что все компоненты прекращены, очищает журналы состояний в базе данных.

### 7. Маршруты (Routes)

#### 7.1. Декоратор авторизации `login_required`

* **Назначение:** Проверяет аутентификацию пользователя перед доступом к защищенным маршрутам.
* **Функция (декоратор):**
  `def login_required(f):`
  **Описание:** Использует сессионные данные Flask для контроля доступа к ресурсам, требующим авторизации.

#### 7.2. Маршрут входа `login`

* **URL:** `/ego1/cloner/login`
* **Методы:** `GET`, `POST`
* **Описание:** Обрабатывает форму входа, выполняет проверку учётных данных и устанавливает/сохраняет сеанс
  пользователя.

#### 7.3. Маршрут создания бота `create_bot_route`

* **URL:** `/ego1/cloner/create_bot`
* **Методы:** `POST`
* **Описание:** Получает данные формы и вызывает метод `create_clone()` для создания нового экземпляра клона.

#### 7.4. Маршрут старта компонента `start_component_route`

* **URL:** `/ego1/cloner/start/<clone_name>/<component>`
* **Описание:** Передаёт управление методом `start_component()`, инициируя запуск нужного компонента.

#### 7.5. Маршрут остановки компонента (`stop_component_route`)

* **URL:** `/ego1/cloner/stop/<clone_name>/<component>`
* **Описание:** Управляет процессом прекращения работы компонента посредством метода `stop_component()`

#### 7.6. Маршрут удаления клона `delete_clone_route`

* **URL:** `/ego1/cloner/delete/<clone_name>`
* **Описание:** Полностью уничтожает клон приложения, очищая файлы и таблицы MySQL.

#### 7.7. Индекс-контроллер `index`

* **URL:** `/ego1/cloner`
* **Описание:** Основной контроллер интерфейса управления клонами. Отображает список существующих клонов и предоставляет
  возможность управления ими (просмотр, запуск/остановка компонентов).

### 8. Низкоуровневые утилиты и настройки

#### 8.1. Конфигурация Nginx `create_nginx_config`

* **Назначение:** Создает конфиг-файл для сервера Nginx, обеспечивая правильную работу виртуальных хостов.
* **Функция:**
  `def create_nginx_config(bot_number, port, vk_port, websocket_port):`
  **Описание:** Генерирует конфигурационный файл для Nginx, определяя маршруты для HTTP-прокси и вебсокетов.

#### 8.2. Релоад Nginx `reload_nginx`

* **Назначение:** Перезагружает сервис Nginx для применения новых настроек.
* **Функция:**
  `def reload_nginx():`
  **Описание:** Использует команду 'systemctl reload nginx' для перезагрузки сервиса.

#### 8.3. Создание таблиц БД `create_tables`

* **Назначение:** Создает структуру таблиц в базе данных MySQL для каждого клона.
* **Функция:**
  `def create_tables(bot_number):`
  **Описание:** Определяет SQL-команды для создания набора таблиц и индексов, специфичных для каждой копии приложения.

## 2. Окружение, необходимое для работы

Для функционирования данного модуля необходимы следующие зависимости и окружение:

### Зависимости Python

* **Python:** >= 3.6
* **Flask:** Фреймворк для веб-разработки.
* **PyMongo:** Библиотека для взаимодействия с MongoDB.
* **MySQL Connector/Python:** Драйвер для подключения к серверу MySQL.
* **psutil:** Утилиты для мониторинга системы и процессов.
* **Subprocess:** Модуль для выполнения команд оболочки.
* **Shutil:** Модуль для операций с файлами и папками.
* **Dotenv:** Загрузка переменных окружения из *.env*-файлов.
* **Logging:** Стандартная библиотека для журналирования.
* **Socket:** Работа с сетевыми сокетами.
* **FCNTL:** POSIX совместимый контроль над файловыми дескрипторами.
* **OS:** Взаимодействие с операционной системой.
* **Time:** Обработка временных меток.

### Необходимые сервисы

* **Nginx:** Веб-сервер для обработки входящих запросов.
* **MySQL Server:** База данных для хранения основных данных.
* **MongoDB:** NoSQL база данных для сохранения метаданных клонов.

### Требуемые права доступа и разрешения

* **Nginx:** Доступ к изменению каталога `/etc/nginx/vhosts/`
* **Bots Directory:** Права на запись в каталог `/bots/`
* **MySQL:** Возможность создавать новые базы данных.

3. ### Связи между модулями и дополнительными модулями

| Компонент         | Входящие связи        | Исходящие связи                 |
|-------------------|-----------------------|---------------------------------|
| Main App          | Flask, PyMongo, MySQL | Клиенты (браузеры, API запросы) |
| Logging           | Main App              | Файлы журналов (.log)           |
| DB Config         | Main App              | MySQL Database                  |
| Clone Creator     | Main App              | MySQL, File System, Subprocess  |
| Component Starter | Main App              | Processes (Python scripts)      |
| Cleanup           | Main App              | MySQL, File System              |
| Login Route       | Main App              | Session Data (Cookies)          |
| Index Controller  | Main App              | Templates (HTML)                |
| Create Bot Route  | Main App              | Forms (POST data)               |
| Start/Stop Routes | Main App              | Components (Bot, Billing etc.)  |
| Delete Route      | Main App              | File System, MySQL              |
| Nginx Config      | Main App              | Nginx Configuration Files       |
| Reload Nginx      | Main App              | Nginx Service                   |
| Table Creation    | Main App              | MySQL Tables                    

**Заключение:**
Данная система представляет собой механизм автоматизации создания и управления множественными экземплярами (клонами)
веб-приложений. 